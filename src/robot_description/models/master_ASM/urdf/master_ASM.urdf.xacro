<?xml version="1.0" encoding="utf-8"?>
<robot name="Master_ASM" xmlns:xacro="http://www.ros.org/wiki/xacro">
  <xacro:property name="PI" value="3.1415926535897931"/>

  <xacro:property name="chassisHeight" value="0.1"/>
  <xacro:property name="chassisLength" value="0.8"/>
  <xacro:property name="chassisWidth" value="0.5"/>
  <xacro:property name="chassisMass" value="50"/>
  <xacro:property name="wheelWidth" value="0.05"/>
  <xacro:property name="wheelRadius" value="0.2"/>
  <xacro:property name="wheelMass" value="5"/>

  <xacro:macro name="box_inertia" params="m x y z">
    <inertia  ixx="${m*(y*y+z*z)/12}" ixy = "0" ixz = "0"
      iyy="${m*(x*x+z*z)/12}" iyz = "0"
      izz="${m*(x*x+z*z)/12}"/>
  </xacro:macro>
  <xacro:macro name="cylinder_inertia" params="m r h">
    <inertia  ixx="${m*(3*r*r+h*h)/12}" ixy = "0" ixz = "0"
      iyy="${m*(3*r*r+h*h)/12}" iyz = "0"
      izz="${m*r*r/2}"/>
  </xacro:macro>

  <material name="silver">
    <color rgba="0.700 0.700 0.700 1.000"/>
  </material>

  <link name="base_link">
    <inertial>
      <origin rpy="0 0 0" xyz="0 0.0 0.08835894305363262"/>
      <mass value="${chassisMass}"/>
      <xacro:box_inertia m="${chassisMass}" x="${chassisLength}" y="${chassisWidth}" z="${chassisHeight}"/>
    </inertial>
    <visual>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <geometry>
        <mesh filename="package://robot_description/models/master_ASM/meshes/base_link.stl" scale="0.001 0.001 0.001"/>
      </geometry>
      <material name="silver"/>
    </visual>
    <collision>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <geometry>
        <mesh filename="package://robot_description/models/master_ASM/meshes/base_link.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
  </link>

  <link name="right_front">
    <inertial>
      <origin rpy="0 0 0" xyz="-4.3576253716537394e-14 -0.022224999999999995 -2.736260904245835e-07"/>
      <mass value="${wheelMass}"/>
      <xacro:cylinder_inertia m="${wheelMass}" r="${wheelRadius}" h="${wheelWidth}"/>
    </inertial>
    <visual>
      <origin rpy="0 0 0" xyz="-0.254 0.254 -0.101276"/>
      <geometry>
        <mesh filename="package://robot_description/models/master_ASM/meshes/right_front.stl" scale="0.001 0.001 0.001"/>
      </geometry>
      <material name="silver"/>
    </visual>
    <collision>
      <origin rpy="0 0 0" xyz="-0.254 0.254 -0.101276"/>
      <geometry>
        <mesh filename="package://robot_description/models/master_ASM/meshes/right_front.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
  </link>

  <link name="left_front">
    <inertial>
      <origin rpy="0 0 0" xyz="-4.3576253716537394e-14 0.02222499999999994 -2.736260904245835e-07"/>
      <mass value="${wheelMass}"/>
      <xacro:cylinder_inertia m="${wheelMass}" r="${wheelRadius}" h="${wheelWidth}"/>
    </inertial>
    <visual>
      <origin rpy="0 0 0" xyz="-0.254 -0.254 -0.101276"/>
      <geometry>
        <mesh filename="package://robot_description/models/master_ASM/meshes/left_front.stl" scale="0.001 0.001 0.001"/>
      </geometry>
      <material name="silver"/>
    </visual>
    <collision>
      <origin rpy="0 0 0" xyz="-0.254 -0.254 -0.101276"/>
      <geometry>
        <mesh filename="package://robot_description/models/master_ASM/meshes/left_front.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
  </link>

  <link name="left_back">
    <inertial>
      <origin rpy="0 0 0" xyz="-4.346523141407488e-14 0.02222499999999994 -2.7362609036907237e-07"/>
      <mass value="${wheelMass}"/>
      <xacro:cylinder_inertia m="${wheelMass}" r="${wheelRadius}" h="${wheelWidth}"/>
    </inertial>
    <visual>
      <origin rpy="0 0 0" xyz="0.254 -0.254 -0.101276"/>
      <geometry>
        <mesh filename="package://robot_description/models/master_ASM/meshes/left_back.stl" scale="0.001 0.001 0.001"/>
      </geometry>
      <material name="silver"/>
    </visual>
    <collision>
      <origin rpy="0 0 0" xyz="0.254 -0.254 -0.101276"/>
      <geometry>
        <mesh filename="package://robot_description/models/master_ASM/meshes/left_back.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
  </link>

  <link name="right_back">
    <inertial>
      <origin rpy="0 0 0" xyz="-4.3520742565306136e-14 -0.022224999999999995 -2.736260904245835e-07"/>
      <mass value="${wheelMass}"/>
      <xacro:cylinder_inertia m="${wheelMass}" r="${wheelRadius}" h="${wheelWidth}"/>
    </inertial>
    <visual>
      <origin rpy="0 0 0" xyz="0.254 0.254 -0.101276"/>
      <geometry>
        <mesh filename="package://robot_description/models/master_ASM/meshes/right_back.stl" scale="0.001 0.001 0.001"/>
      </geometry>
      <material name="silver"/>
    </visual>
    <collision>
      <origin rpy="0 0 0" xyz="0.254 0.254 -0.101276"/>
      <geometry>
        <mesh filename="package://robot_description/models/master_ASM/meshes/right_back.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
  </link>

  <!-- ZED 2i Camera -->
  <xacro:arg name="use_zed_localization" default="true"/>
  <xacro:include filename="$(find zed_wrapper)/urdf/zed_macro.urdf.xacro"/>
  <xacro:zed_camera name="zed2i" model="zed2i" enable_gnss="false">
    <!-- This block is required even if enable_gnss="false" for some reason, but you can leave it empty -->
    <gnss_origin></gnss_origin>
  </xacro:zed_camera>
  <!-- Add a joint to connect the ZED 2i Camera model to the robot -->
  <xacro:if value="$(arg use_zed_localization)">
    <!-- ZED Localization -> The reference link is 'zed2i_camera_link' and 'base_link' is a child -->
    <joint name="zed2i_joint" type="fixed">
      <parent link="zed2i_camera_link"/>
      <child link="base_link"/>
      <origin xyz="-0.5 0 0.375" rpy="0 0 0"/>
    </joint>    
  </xacro:if>
  <xacro:unless value="$(arg use_zed_localization)">
    <!-- NO ZED Localization -> 'zed2i_camera_link' is a child of 'base_link' -->
    <joint name="zed2i_joint" type="fixed">
      <parent link="base_link"/>
      <child link="zed2i_camera_link"/>
      <origin xyz="0.5 0 -0.375" rpy="0 0 0"/>
    </joint>
  </xacro:unless>

  <gazebo reference="zed2i_camera_link">
    <sensor name="camera" type="camera">
      <!-- <visualize>true</visualize> -->
      <always_on>true</always_on>
      <update_rate>30</update_rate>
      <camera>
        <horizontal_fov>1.91986218</horizontal_fov> 
        <image>
          <format>R8G8B8</format>
          <width>1280</width>
          <height>720</height>
        </image>
        <clip>
          <near>0.3</near>
          <far>5.0</far>
        </clip>
      </camera>
      <topic>/color/image</topic>
      <info_topic>/color/camera_info</info_topic>
      <gz_frame_id>zed2i_left_camera_optical_frame</gz_frame_id>
    </sensor>
    <sensor name="depthcamera" type="depth">
      <!-- <visualize>true</visualize> -->
      <always_on>true</always_on>
      <update_rate>30</update_rate>
      <camera>
        <horizontal_fov>1.91986218</horizontal_fov> 
        <image>
          <format>R8G8B8</format>
          <width>1280</width>
          <height>720</height>
        </image>
        <clip>
          <near>0.3</near>
          <far>20.0</far>
        </clip>
      </camera>
      <topic>/depth/image</topic>
      <info_topic>/depth/camera_info</info_topic>
      <gz_frame_id>zed2i_left_camera_optical_frame</gz_frame_id>
    </sensor>
  </gazebo>

  <joint name="right_front_wheel" type="continuous">
    <origin rpy="0 0 0" xyz="0.254 -0.254 0.101276"/>
    <parent link="base_link"/>
    <child link="right_front"/>
    <axis xyz="0.0 1.0 0.0"/>
  </joint>
  <joint name="left_front_wheel" type="continuous">
    <origin rpy="0 0 0" xyz="0.254 0.254 0.101276"/>
    <parent link="base_link"/>
    <child link="left_front"/>
    <axis xyz="0.0 -1.0 0.0"/>
  </joint>
  <joint name="left_back_wheel" type="continuous">
    <origin rpy="0 0 0" xyz="-0.254 0.254 0.101276"/>
    <parent link="base_link"/>
    <child link="left_back"/>
    <axis xyz="0.0 -1.0 0.0"/>
  </joint>
  <joint name="right_back_wheel" type="continuous">
    <origin rpy="0 0 0" xyz="-0.254 -0.254 0.101276"/>
    <parent link="base_link"/>
    <child link="right_back"/>
    <axis xyz="0.0 1.0 0.0"/>
  </joint>

  <gazebo>
    <plugin
      filename="ignition-gazebo-joint-state-publisher-system"
      name="ignition::gazebo::systems::JointStatePublisher">
      <topic>joint_states</topic>
    </plugin>
    <plugin
      filename="ignition-gazebo-joint-controller-system"
      name="ignition::gazebo::systems::JointController">
      <joint_name>right_front_wheel</joint_name>
      <initial_velocity>0.0</initial_velocity>
      <topic>right_front_wheel/cmd_vel</topic>
    </plugin>
    <plugin
      filename="ignition-gazebo-joint-controller-system"
      name="ignition::gazebo::systems::JointController">
      <joint_name>left_front_wheel</joint_name>
      <initial_velocity>0.0</initial_velocity>
      <topic>left_front_wheel/cmd_vel</topic>
    </plugin>
    <plugin
      filename="ignition-gazebo-joint-controller-system"
      name="ignition::gazebo::systems::JointController">
      <joint_name>left_back_wheel</joint_name>
      <initial_velocity>0.0</initial_velocity>
      <topic>left_back_wheel/cmd_vel</topic>
    </plugin>
    <plugin
      filename="ignition-gazebo-joint-controller-system"
      name="ignition::gazebo::systems::JointController">
      <joint_name>right_back_wheel</joint_name>
      <initial_velocity>0.0</initial_velocity>
      <topic>right_back_wheel/cmd_vel</topic>
    </plugin>
  </gazebo>

</robot>